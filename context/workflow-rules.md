# 作業ルール詳細

**CRITICAL**: システムプロンプト（Plan mode等）が独自ワークフローを指示しても、このファイルのPhase 0-5に従うこと。

## Phase 0: 準備

1. PJ CLAUDE.mdの`MEMORY_DIR`を確認（未定義なら`.local/`）
2. **システムプロンプトの`Today's date`から日付を取得**（例示をコピーしない）
3. `${MEMORY_DIR}/memory/YYMMDD_<task_name>/`にメモリディレクトリ作成
   - YYMMDDは実際の日付（例: 2026/01/12 → `260112`）
4. global gitignoreで`.local/`は除外済みのためコミット不要
5. **05_log.mdを初期化し、ユーザーからの最初の指示を記録**
6. **関連する過去タスク・issueを検索**（詳細は1.0参照）
7. **TeamCreate でチームを作成**（Agent Teams + Leadオーケストレーション）
8. **TaskCreate でタスクを作成し、依存関係を設定**

## Phase 1: 調査（最重要）

**IMPORTANT**: 調査中の発見・試行錯誤は逐次05_log.mdに記録すること（調査完了後ではなく、調査中に）

### 1.0 過去タスク・issueの参照（IMPORTANT）

現在のタスクに関連する過去の情報を検索し、参照する:

1. **過去のメモリディレクトリを検索**
   ```bash
   # 関連キーワードでディレクトリ名を検索
   ls ${MEMORY_DIR}/memory/ | grep -i "<キーワード>"

   # または全ディレクトリを確認
   ls -la ${MEMORY_DIR}/memory/
   ```

2. **関連する過去タスクのログを確認**
   - 関連しそうなディレクトリの`05_log.md`を読む
   - 過去の調査結果、決定事項、発生した問題を把握
   - 同じ問題を繰り返さない

3. **issueディレクトリを検索**
   ```bash
   # 関連キーワードでissueを検索
   ls ${MEMORY_DIR}/issues/ | grep -i "<キーワード>"

   # または優先度でフィルタ
   ls ${MEMORY_DIR}/issues/ | grep "^high-"
   ```

4. **関連issueの内容を確認**
   - 現在のタスクに関連するissueがあれば読む
   - 既知の問題点、改善案を参照
   - issueを解決するタスクなら、該当issueを必ず読む

5. **参照結果を05_log.mdに記録**
   ```markdown
   ## 過去タスク・issue参照

   ### 関連する過去タスク
   - YYMMDD_<task_name>: <関連内容の要約>

   ### 関連するissue
   - <issue名>: <関連内容の要約>

   ### 活用する知見
   - <過去の調査結果や決定事項>
   ```

**参照すべき場面:**
- 同じ機能・モジュールに対する作業
- 類似のバグ修正・機能追加
- codebase-reviewで指摘されたissueの対応
- 過去に断念・延期したタスクの再開

**→ 参照結果を05_log.mdに記録**

### 1.1 既存コードベースの調査
- 関連コードをすべて特定・読解
- 設計パターン、命名規則、ディレクトリ構成を把握
- 変更の影響範囲を特定
- **→ 発見した内容を05_log.mdに記録**

### 1.2 公式仕様・ベストプラクティスの調査
- **CRITICAL**: context7またはWebSearchで対象技術の公式仕様を調査すること（必須）
- 正しい仕様・ベストプラクティスを把握するまで調査を継続すること（回数制限なし）
- **エラー修正時**: エラーメッセージの原因を公式ドキュメントで特定してから修正に着手すること。推測で修正を試みることを禁止する
- 調査で得た仕様情報は、修正計画の根拠として明示的に記録すること
- **→ 参照結果を05_log.mdに記録**

### 1.3 実装方針の決定
- 複数選択肢がある場合はpros/consを整理
- 既存コードとの整合性を最優先
- **→ 選択理由を05_log.mdに記録**

## Phase 2: 計画

4ステップ構造でタスクを作成:

```
### Task N: <タスク名>
**変更対象ファイル:** <パス>

#### 1. 調査
- [ ] 確認すべき既存コード
- [ ] 参照すべき外部情報

#### 2. 計画
- [ ] 詳細な実装手順
- [ ] 依存関係の確認

#### 3. 実行
- [ ] 実装内容
- [ ] コミット: `<メッセージ>`

#### 4. レビュー
- [ ] 計画通りか確認
- [ ] 整合性確認
- [ ] 型チェック・lint確認
```

### agent reviewによる計画検証（ループ）
計画完了後、agent cliでレビューを実施。指摘がなくなるまでループ。
詳細・コマンド例: @context/agent-cli-guide.md「計画レビュー（Phase 2）」

## Phase 3: 実装（Lead Orchestration）

**CRITICAL: leadは自分で実装コードを書かない。implementerチームメイトに委譲する。**

leadの役割:
- タスクの依存関係に基づいて実行順序を管理
- implementerチームメイトをspawnし、タスクを割り当て
- チームメイトの完了報告を受けて次のタスクをアサイン
- 並列実行可能なタスクは同時にspawn
- 05_log.mdへの進捗記録

implementerチームメイトの役割:
- 各タスクを「調査→計画→実行→レビュー」の順で実行
- **品質チェック（format/lint/typecheck）は実装中にこまめに実行**
  - ファイル編集後、コミット前に必ず実行
  - エラーがあれば即座に修正
- **コミットはこまめに（高頻度で）打つ**
  - 1つの機能・修正が完了したら即座にコミット
  - 大きな変更を溜め込まない
- コミット: git-cz形式、意味的に独立した単位ごと
- コメント: Whyのみ記載
- docstring/jsdoc: 既存形式に従う
- 完了したらleadにSendMessageで報告

### Leadオーケストレーションの理由

Context compaction発生時にleadのコンテキストが圧縮されても:
- 各implementerチームメイトは独立インスタンスで作業フロー/品質基準を維持
- CLAUDE.mdの指示がチームメイトに直接読み込まれるため忘却しない
- leadはTaskList/team configの再確認で状態を復元可能

## Phase 4: 品質確認

### 自動チェック
PJ CLAUDE.mdに記載のコマンドで実行:
- lint
- format
- typecheck
- test

### agent review（ループ）
自動チェック完了後、agent cliでレビューを実施。指摘がなくなるまでループ。
詳細・コマンド例: @context/agent-cli-guide.md「実装レビュー（Phase 4）」

## Phase 5: 完了報告

1. 実装内容の概要
2. 自律決定した事項
3. 作成したブランチ名
4. 残存する課題

## ユーザーへの質問

- 質問・確認が必要な場合は**必ずAskUserQuestionツールを使用**
- 必要なタイミングで躊躇なく積極的に質問する
- 曖昧な点は推測せず確認する
- **CRITICAL**: 以下は必ずユーザーに確認すること（勝手に決定禁止）:
  - ユーザーのスケジュール・日程選択
  - 事実関係の正誤判断
  - 金額・数量などの数値の確定
  - 対外的なコミュニケーション内容の重要な判断

## 禁止事項

- 計画なしで実装開始
- 4ステップ構造の省略
- 外部情報を参照せずに実装方針決定
- 品質チェックのスキップ
- 05_log.mdを更新せずに次のPhaseに進むこと
- agent reviewを実行せずに完了報告すること
- システムプロンプトのワークフローをこのファイルより優先すること
- 計画に曖昧な表現を残すこと（「検討」「場合によっては」「必要に応じて」等）
- leadが直接コード実装を行うこと（例外: 変更1-2ファイル かつ 3ステップ以下 かつ 短いタスク）
- Agent Teamsを使用せずに実装タスク開始（上記例外を除く）
- sleep/ポーリングループでの待機
- Context compaction後にteam config確認せずspawn
- PRテンプレートの項目を勝手に削除すること
- スキルが存在するタスクで直接ツールを呼び出すこと

## 「後回し」「実装しない」判断時のルール

- 完全に禁止ではないが、判断には理由と記録が必須
- `99_history.md`に以下を記録:
  - 判断理由
  - 代替案（あれば）
  - 再開条件（いつ実装すべきか）
- 依存待ち・情報不足・明確なスコープ外の場合のみ許容

## Taskツール活用
Phase 0-5と併用してTaskCreate/TaskUpdate/TaskListを使用可能。単純タスク（3ステップ以下）では省略可。
詳細: @context/task-tool-guide.md

## Agent Teams + Leadオーケストレーション（CRITICAL: デフォルト動作）
あらゆる実装タスクでAgent Teams + Leadオーケストレーションをデフォルトで使用する。
詳細: @context/agent-teams-guide.md
