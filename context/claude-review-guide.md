# Claude review ガイド

## 概要

別セッションのClaude Code（`claude -p`）を使用して、計画・実装のレビューを実施する。
同一セッションではなく別セッションでレビューすることで、異なる視点からの分析が可能になる。

**重要**: Claudeは自分自身でレビューコマンドを実行できないため、ユーザーに実行を依頼する。

## 基本コマンド

```bash
claude -p "<プロンプト>" --output-format text
```

### 主要オプション

| オプション | 説明 |
|-----------|------|
| `-p, --print` | 非対話モード、結果を出力 |
| `--output-format <format>` | 出力形式（text/json/stream-json） |
| `--model <model>` | モデル指定（sonnet/opus/haiku） |
| `--continue` | 直前のセッションを継続 |
| `--resume <session_id>` | 特定のセッションを再開 |

## レビュー用コマンド例

### 1. 計画レビュー（Phase 2）

```bash
claude -p "以下の計画をレビューしてください。
- 抜け漏れがないか
- リスクや懸念点
- より良いアプローチの提案

指摘がなければ「指摘なし」とだけ回答してください。

計画内容:
$(cat ${MEMORY_DIR}/memory/<task>/30_plan.md)" --output-format text
```

### 2. 実装レビュー（Phase 4）

```bash
# BASE_BRANCHはPJ CLAUDE.mdで定義された値を使用
claude -p "以下のコード変更をレビューしてください。
- バグや論理エラー
- セキュリティ上の問題
- パフォーマンス改善点
- ベストプラクティス違反

指摘がなければ「指摘なし」とだけ回答してください。

変更内容:
$(git diff $BASE_BRANCH)" --output-format text
```

### 3. PRレビュー

```bash
claude -p "以下のPRをレビューしてください。
- 変更の妥当性
- テストの十分性
- ドキュメントの更新必要性

指摘がなければ「指摘なし」とだけ回答してください。

PR diff:
$(gh pr diff <番号>)" --output-format text
```

### 4. セッション継続（追加レビュー）

```bash
# 直前のセッションを継続
claude -p "以下の改善を行いました:
- [改善内容1]
- [改善内容2]

再度レビューしてください。指摘がなければ「指摘なし」とだけ回答してください。" \
  --continue --output-format text
```

## 出力形式

| 形式 | 説明 | 用途 |
|------|------|------|
| `text` | プレーンテキスト（デフォルト） | 通常のレビュー |
| `json` | 構造化JSON | スクリプト連携 |
| `stream-json` | ストリーミングJSON | 長時間処理 |

## レビューループの流れ

1. **Claudeがユーザーにレビュー実行を依頼**
   - レビュー対象を明示
   - 実行コマンド例を提示

2. **ユーザーがコマンドを実行**
   - 別ターミナルで`claude -p`を実行
   - 結果をClaudeに共有

3. **Claudeが指摘に対応**
   - 「絶対にやるべき」指摘は必ず修正
   - それ以外はやる/やらない判断
   - 不明点はAskUserQuestionで確認

4. **修正後、再度レビューを依頼**
   - `--continue`で継続レビュー
   - 指摘がなくなるまで繰り返し

## モデル選択ガイド

| モデル | 特徴 | 推奨用途 |
|--------|------|----------|
| `sonnet` | バランス型（デフォルト） | 一般的なレビュー |
| `opus` | 高精度 | 複雑なアーキテクチャレビュー |
| `haiku` | 高速・軽量 | 軽微な変更のレビュー |

```bash
# Opusでレビュー
claude -p "..." --model opus --output-format text
```

## 注意事項

- `-p`モード（非対話モード）ではスキル（`/commit`等）は使用不可
- 大きなdiffはトークン制限に注意
- セッション継続は`--continue`（直前）または`--resume <id>`（特定）を使用
